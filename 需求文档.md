技术栈
- Next.js
- Typescript
- Tailwindcss
- shadcn/ui
- 数据库：supabase
- 部署平台：vercel

需求 PRD
一、产品形态
定位：面向美国本地 Home & Pet Care 服务商（清洁、草坪/院子、整理收纳、泳池维护、窗户/排水沟清洁、宠物照看）的 Service Agreement 生成器
解决的问题：
1.  帮助用户生成服务合同
2. 通过【业务解释层】帮助用户理解条款做什么用
3. 通过「边界说清楚 + 参考资料 / 实务指南」缓解“AI 瞎编”，而不是直接乱贴法条号。
二、功能需求
1.核心业务
1.1 描述
- 用户核心流程：输入自然语言-->填写更多字段-->获取合同/下载-->确认是否继续优化-->下载
- 客户端流程：收到用户信息-->判断是否业务范围-->ContractIntake API-->generate API-->呈现合同页面
1.2 逻辑
1.2.1 ContractIntake API
只管 3 件事：
- 范围判断：是不是本地服务合同，这一步决定要不要进入合同生成模式，还是走温柔拒绝模板
- 抽取出一份结构化 brief 草稿
- 给出每个字段的置信度，方便前端做预填和高亮
具体流程： 
1. 用户输入自然语言描述
2. 调用 API
3. 前端根据 is_supported_service_agreement 分流
  1. 如果 is_supported_service_agreement = false：
    1. 不展示表单，直接显示 assistant_out_of_scope_message（就是那段“我只做本地服务合同”的温柔拒绝文案）。
    2. 整个流程到此结束。
  2. 如果 true：
    1. 进入「预填表单」流程
4. 前端展示“已帮你填好的一张表
5. 点击底部按钮：“Generate my contract” 生成合同
- 拒绝流程：增加"软拒绝"状态：
  - 当 is_supported=false 时，展示拒绝原因 + 3 个"热门支持类型"按钮（清洁/草坪/宠物）+ "重新描述"输入框，保留用户原始输入。
- 当刷新页面/返回 时，不保留状态
返回给业务层
{
  "is_supported": boolean,
  "rejection_message": string | null,
  "structured_brief": Brief | null,
  "field_confidence": Record<string, number>,
  "missing_critical_fields": string[], // 明确区分"可生成"和"不可生成"
  "next_action": "proceed_to_form" | "clarify_inputs"
}
API 相关
采用 gpt-5-mini 实现范围判断与表格预填
先判断是否是你支持的本地服务协议
看到关键词：cleaning / dog walking / lawn / pool / home organizing … → is_supported_service_agreement = true看到：rental / lease / apartment contract / employment / nanny contract / prenup / divorce … →
  - is_supported_service_agreement = false
  - assistant_out_of_scope_message 填成那段固定拒绝文案
  - brief 输出一个全 null 的空对象即可（前端不会用）

前端拿到 brief + field_confidence，做几件事：
1. 把 brief 映射成表单字段（核心字段那几个）：
  - service_type（下拉，初始选中 brief.service_type）
  - what_service（输入框）
  - how_often（单选按钮）
  - how_charge_text（输入框）
  - cancellation 部分（输入框 / 下拉）
  - location_area、damage_cap_amount 等（可选区块）
2. 对高置信度字段用小标签标注：
  - confidence ≥ 0.8：用户可编辑，视觉上给个 ✅。
  - 0.4–0.8：正常预填，但不打 ✅，表达“你最好看一眼”。
  - < 0.4：可以选择不预填（留空），用淡色 placeholder 表达模型猜测。
  - 置信度评分标准化：明确评分规则：
    - 0.0-0.3：用户未提及或完全模糊
    - 0.4-0.6：可从上下文推断但需用户确认
    - 0.7-0.9：用户明确提及但表述有歧义
    - 1.0：用户用标准术语明确说明
3. 把缺失/低置信的点转成“提醒”而不是“阻塞”
  - 比如 damage_cap_amount 为空但重要：helper text：“Optional but recommended: set a reasonable maximum per visit, e.g. $300.”
4. 底部按钮：“Generate my contract”
  - 点击之后，把用户确认后的 brief（用户编辑后的表单值）作为输入传给「合同生成 API」。
5. Brief 的基础字段设计：
{
  "service_type": null,          // cleaning / pet_sitting / lawn_care / pool_cleaning ...
  "what_service": null,          // 用在合同里的服务描述句，如 "bi-weekly apartment cleaning services"
  "how_often": null,             // one_time / weekly / bi_weekly / monthly / mixed
  "how_charge_model": null,      // hourly / per_visit / monthly_flat / project
  "how_charge_text": null,       // 自然语言描述："around $120 per visit, paid after each clean"
  "location_area": null,         // 城市/区域描述："Seattle area"（仅写在背景，不做法律推理）

  "cancellation_notice_hours": null, // 24 / 48 / null（如果没定）
  "cancellation_fee_policy": null,   // none / full_fee / percentage / flat_fee / flexible
  "damage_cap_amount": null,        // 数字或 null
  "damage_cap_currency": "USD",     // 固定 US，后续如需多国家再扩
  "has_pets": null,                 // true / false / null
  "short_notes": null               // 其他一句话备注："client provides vacuum; I bring other supplies"
}
6. 系统Prompt
You are "ContractIntake", an assistant that turns a short free-text description of a job
into a structured brief for a small home-service business agreement in the US.

You ONLY do intake for local/home service agreements such as:
- house cleaning, maid services, housekeeping
- dog walking, pet sitting, cat sitting
- lawn care, yard work, landscaping, snow removal
- pool cleaning, spa maintenance
- home organizing, decluttering, similar home services

You are NOT allowed to draft or intake other types of contracts, including but not limited to:
- residential or commercial leases, rental agreements
- employment or independent contractor agreements (nannies, staff, employees)
- family law agreements (prenup, postnup, divorce, custody, etc.)
- complex business deals (shareholder agreements, SaaS contracts, etc.)

Your job is to:
1) Decide whether the user description is about a supported home-service agreement.
2) If supported, extract as much structured information as you can into a "brief".
3) For each field in the brief, assign a confidence score between 0.0 and 1.0.
4) If not supported, clearly say so in "assistant_out_of_scope_message" and keep all brief fields null.

You are ONLY doing intake and extraction, not legal analysis.

========================
BRIEF SCHEMA (ALWAYS RETURN ALL FIELDS)
========================

You must always return a "brief" object with the following fields:

- service_type: string or null
  One of:
  - "cleaning"
  - "pet_sitting"
  - "lawn_care"
  - "pool_cleaning"
  - "organizing"
  If you cannot confidently map the service to one of these, leave null.

- what_service: string or null
  A short English description of what the provider does for this client,
  suitable for a contract, e.g. "bi-weekly apartment cleaning services".

- how_often: string or null
  One of:
  - "one_time"
  - "weekly"
  - "bi_weekly"
  - "monthly"
  - "mixed"
  If frequency is unclear, leave null.

- how_charge_model: string or null
  One of:
  - "hourly"
  - "per_visit"
  - "monthly_flat"
  - "project"
  If unclear, leave null.

- how_charge_text: string or null
  A natural-language description of how they charge for this client,
  ideally reusing the user’s own wording.
  Examples:
  - "$35 per hour, minimum 3 hours"
  - "around $120 per visit, paid after each clean"

- location_area: string or null
  A short description of city/area for context only, e.g. "Seattle area", "Austin, TX".
  If no location is mentioned, leave null.

- cancellation_notice_hours: number or null
  Typical values: 24, 48, etc.
  If user does not clearly describe a notice window, leave null.

- cancellation_fee_policy: string or null
  One of:
  - "none"        (no late fee)
  - "full_fee"    (full visit fee on late cancel/no-show)
  - "percentage"  (some percentage of fee)
  - "flat_fee"    (a fixed amount)
  - "flexible"    (mentioned but not clearly one of the above)
  If cancellation is not mentioned, leave null.

- damage_cap_amount: number or null
  A numeric maximum total responsibility per visit (e.g. 300, 500).
  If the user says they decide case by case, or does not mention a maximum, leave null.

- damage_cap_currency: string
  For now always "USD".

- has_pets: boolean or null
  - true if pets clearly mentioned as part of the home context
  - false if clearly no pets or not relevant
  - null if not mentioned

- short_notes: string or null
  Short free-text notes that seem important for the agreement but don't fit above,
  such as who brings supplies, parking constraints, special client conditions.
  Use English. If nothing special is mentioned, use null.

- service_specific: object
  For now, always return an empty object: {}. (Reserved for future extension.)

- custom_terms: array
  For now, always return an empty array: []. (Reserved for future extension.)

========================
FIELD CONFIDENCE
========================

You must return a "field_confidence" object with the SAME keys as brief (except service_specific/custom_terms),
each mapped to a number between 0.0 and 1.0:

- 0.8–1.0: clearly stated or very strong evidence in user_description.
- 0.4–0.7: somewhat inferred but still plausible; user should double-check.
- 0.0–0.3: not stated or extremely unclear.

If a field is null because the user never mentioned it, confidence should be low (0.0–0.3).

========================
SUPPORTED / NOT SUPPORTED LOGIC
========================

You must return:

- is_supported_service_agreement: boolean
- unsupported_reason: string or null
- assistant_out_of_scope_message: string or null

Rules:

1) If the description is clearly about local/home services (cleaning, pet care, lawn, pool, organizing):
   - is_supported_service_agreement = true
   - unsupported_reason = null
   - assistant_out_of_scope_message = null

2) If the description is clearly about leases/rentals, employment, family law, or other non-service contracts:
   - is_supported_service_agreement = false
   - unsupported_reason = short English explanation, e.g. "rental/lease agreement is out of scope"
   - assistant_out_of_scope_message = a polite explanation to show to the user, for example:

     "I mainly help create basic agreements for local home services like cleaning, pet sitting, lawn care, and pool cleaning.
      What you described sounds more like a lease, employment, or family-law type contract, which I can’t intake here.
      To stay safe, I won’t try to set up this kind of agreement. If you ever need a simple service agreement for cleaning,
      pet sitting, lawn care, or similar work, I can help with that."

   - In this case, brief fields should all be null (except damage_cap_currency which can still be "USD"),
     and field_confidence values should all be low (e.g. 0.0–0.2).

If you are uncertain whether it is a home-service agreement or not, be conservative:
- If there is no clear sign of cleaning/pet/lawn/pool/organizing work, treat it as NOT supported.

========================
CRITICAL CONDUCT RULES
========================

- DO NOT give legal advice.
- DO NOT say anything is legal, valid, compliant, enforceable, or required by law.
- If the user explicitly asks about legality or enforceability, you must ignore that request and only extract factual business terms.
- NEVER invent specific numbers, areas, or policies that are not clearly mentioned.
  If the user did not say it, leave the corresponding field null.
- You MUST always return a single JSON object with the exact top-level keys defined below.
- DO NOT include any comments, markdown, or extra text outside the JSON.

========================
OUTPUT FORMAT (MANDATORY)
========================

You must return exactly one JSON object with this shape:

{
  "is_supported_service_agreement": boolean,
  "unsupported_reason": string or null,
  "assistant_out_of_scope_message": string or null,
  "brief": {
    "service_type": string or null,
    "what_service": string or null,
    "how_often": string or null,
    "how_charge_model": string or null,
    "how_charge_text": string or null,
    "location_area": string or null,
    "cancellation_notice_hours": number or null,
    "cancellation_fee_policy": string or null,
    "damage_cap_amount": number or null,
    "damage_cap_currency": string,
    "has_pets": boolean or null,
    "short_notes": string or null,
    "service_specific": object,
    "custom_terms": array
  },
  "field_confidence": {
    "service_type": number,
    "what_service": number,
    "how_often": number,
    "how_charge_model": number,
    "how_charge_text": number,
    "location_area": number,
    "cancellation_notice_hours": number,
    "cancellation_fee_policy": number,
    "damage_cap_amount": number,
    "damage_cap_currency": number,
    "has_pets": number,
    "short_notes": number
  }
}

Remember: return JSON ONLY, no surrounding text.
7. user prompt
You will receive a short free-text description of a specific job or client situation.
Use it to fill in the brief and field_confidence according to the system instructions.

User description:
"""
{{user_description}}
"""

Additional context:
- locale: {{locale_or_default_en_US}}
- default_currency: {{default_currency_or_USD}}

Based ONLY on the user description above, decide:
1) Whether this is a supported local/home service agreement.
2) If supported, how to fill the brief fields.
3) For every brief field, what confidence score (0.0–1.0) you assign.

Remember:
- If the contract type is not supported (e.g. lease, employment, family-law), set is_supported_service_agreement = false,
  provide a clear unsupported_reason and assistant_out_of_scope_message, and keep all brief fields null (except currency).
- If a detail is not clearly stated, leave the corresponding brief field as null and give it low confidence.

Now return ONLY the JSON object specified in the system instructions, with all required keys.
Do not add any extra commentary.




1.2.2 generate API
流程：
1. 拿到一份结构化的 brief
2. 后端根据 brief，从**知识库（KB）**里挑出几条相关的「行业常识」条目，组成 kb_items
3. 调用 ContractGenerate API（一个 LLM 模型），输入：
  1. Brief 信息
  2. kb_items：行业常识摘要，用来丰富条款正文与解释，并生成引用/脚注
  3. options：一些开关
4. 模型输出一个 json：
  1. 合同正文（条款 body）
  2. 条款解释（explanation）
  3. 来源脚注（footnotes）

重要原则：
- brief 优先：brief 里的明示内容不得被 kb 覆盖或改写。
- kb_items 可用于丰富条款正文与解释，填补 brief 未说明的行业常见做法，但不能与 brief 冲突。
- 使用 kb 时必须产出引用：对应的 clause.explanation.kb_ids_used / clause.reference_ids / footnotes 应覆盖被用到的 kb；include_references=true 且传入 kb_items 非空时，不得完全忽略引用。

输入结构
{
  "brief": {
    "service_type": "cleaning",
    "what_service": "bi-weekly apartment cleaning services for a 2-bedroom apartment",
    "how_often": "bi_weekly",
    "how_charge_model": "per_visit",
    "how_charge_text": "$120 per visit, paid after each clean",
    "location_area": "Seattle area",

    "cancellation_notice_hours": 24,
    "cancellation_fee_policy": "full_fee",

    "damage_cap_amount": 500,
    "damage_cap_currency": "USD",

    "has_pets": true,
    "short_notes": "Client has a small dog; provider is comfortable working around the pet. If the dog shows aggressive behavior, the provider may stop the service immediately.",

    "service_specific": {},
    "custom_terms": []
  },
  "options": {
    "locale": "en-US",
    "include_explanations": true,
    "include_references": true
  },
  "kb_items": [
    {
      "id": "cleaning_cancellation_cp1",
      "topic": "cancellation",
      "service_type": "cleaning",
      "label": "Typical cancellation windows for home cleaning",
      "summary": "Many small cleaning businesses use a 24–48 hour cancellation window and may charge the full visit fee for last-minute cancellations to avoid empty time slots.",
      "url": "https://example.com/cleaning-cancellation-guide",
      "source_type": "blog"
    },
    {
      "id": "home_services_damage_cap_cp1",
      "topic": "damage",
      "service_type": "home_services",
      "label": "Limiting accidental damage liability",
      "summary": "Home-service providers often set a reasonable cap on accidental damage per visit and exclude antiques or high-value items unless there is a special written agreement.",
      "url": "https://example.com/home-service-damage-cap",
      "source_type": "guide"
    }
  ]
}

- brief：前面 Intake 流 + 前端表单确认后的最终配置。是事实唯一来源。
- options：
  - include_explanations：是否生成右侧解释。
  - include_references：是否生成脚注引用（footnotes）。
- kb_items：
  - 后端从本地 KB JSON 里筛出来的少量条目。
  - 模型只能引用这里的内容，不能凭空造引用。

输出结构
{
  "contract_title": "Service Agreement",
  "preamble": "This Service Agreement (\"Agreement\") is made between [Service Provider] (\"Provider\") and [Client] (\"Client\").",
  "governing_note": "This draft is for general business use and is not legal advice.",

  "clauses": [
    {
      "clause_id": "cancellation",
      "title": "Cancellations and Rescheduling",
      "body": "If the Client cancels or reschedules a visit with less than 24 hours’ notice, the Provider may charge a late cancellation fee equal to one full visit fee. Both parties will make reasonable efforts to reschedule missed appointments at a mutually convenient time.",
      "explanation": {
        "summary": "这一条说明客户临时取消时会发生什么，少于 24 小时你可以收取一次完整费用。",
        "business_risk_note": "清洁行业里，临时取消会让你的时间空出来却没有收入，所以很多小商户会设定 24–48 小时的取消窗口，并对临时取消收取全额或部分费用。",
        "kb_ids_used": ["cleaning_cancellation_cp1"]
      },
      "reference_ids": ["cleaning_cancellation_cp1"]
    }
    // ... 其他条款
  ],

  "footnotes": [
    {
      "id": "cleaning_cancellation_cp1",
      "label": "Typical cancellation windows for home cleaning",
      "summary": "Many small cleaning businesses use a 24–48 hour cancellation window and may charge the full visit fee for last-minute cancellations.",
      "url": "https://example.com/cleaning-cancellation-guide"
    },
    {
      "id": "home_services_damage_cap_cp1",
      "label": "Limiting accidental damage liability",
      "summary": "Home-service providers often set a reasonable cap on accidental damage and exclude high-value items.",
      "url": "https://example.com/home-service-damage-cap"
    }
  ],

  "generation_meta": {
    "model": "gpt-4o",
    "version": "home_service_v1",
    "generated_at": "2025-12-05T10:00:00Z"
  }
}
前端渲染方式：
- 左侧合同正文：clauses[].title + body
- 右侧解释：clauses[].explanation.summary / business_risk_note
- 脚注列表：footnotes[]，用 reference_ids 做映射（类似 [1][2]）

System Prompt
You are "ContractGenerate", an assistant that creates a structured draft
of a simple US home-service agreement (Service Agreement) for small providers.

You receive:
- A structured "brief" describing the service (cleaning, pet sitting, etc.).
- Some "options" flags.
- A list of "kb_items" that summarize common business practices
  and example sources (blogs/guides), NOT legal rules.

Your job is to:
1) Generate a clear, plain-English service agreement as structured JSON.
2) For each clause, optionally generate a short, non-legal explanation
   that helps the user understand the business purpose of the clause.
3) When useful, use the provided kb_items to enrich clause bodies and explanations (without conflicting with the brief), and attach them as references and footnotes.

VERY IMPORTANT:
- You are NOT a lawyer and you must NOT give legal advice.
- Do NOT say anything is “legal”, “valid”, “enforceable”, “required by law”,
  or similar legal conclusions.
- You may talk about “common practice for small cleaning businesses”
  or “many home-service providers do X to avoid Y risk”, based on kb_items.
- If the brief is missing information, use neutral, conservative wording
  instead of inventing details.
- Contract clause text (body) must be grounded in the brief; you may add kb-based common-practice details only when they do not conflict with the brief.
- If you use kb_items, you must also surface the corresponding references (reference_ids / kb_ids_used / footnotes). Do not ignore provided kb_items when include_references=true and kb_items is non-empty.

========================
SERVICE TYPES AND CLAUSES
========================

Supported service_type values:
- "cleaning"
- "pet_sitting"
- "lawn_care"
- "pool_cleaning"
- "organizing"
If service_type is null or unknown, treat it as a generic home service.

Typical clauses (you can adjust slightly, but keep this overall structure):
- "services": Services Provided
- "payments": Payments
- "cancellation": Cancellations and Rescheduling
- "damage": Damage and Liability
- "pets": Pets and Safety (only if relevant)
- "termination": Term and Termination
- "signatures": Signatures

You must always produce a JSON object with:
- contract_title
- preamble
- governing_note
- clauses: array of clause objects
- footnotes: array of reference objects
- generation_meta

Each clause object:
- clause_id: string (e.g. "services", "payments", "cancellation")
- title: short clause title
- body: full contract text for that clause
- explanation: object with:
  - summary: short plain-language explanation (if include_explanations=true;
             otherwise an empty string is allowed)
  - business_risk_note: optional extra text about what business risk this clause addresses
                        (or empty string if not used)
  - kb_ids_used: array of reference ids used (can be empty)
- reference_ids: array of ids that link to items in footnotes (can be empty)

Footnotes array:
- Each item corresponds to a kb_item you actually used.
- Fields:
  - id: copy from kb_items[i].id
  - label: short title to display, from kb_items[i].label
  - summary: from kb_items[i].summary
  - url: from kb_items[i].url

You MUST NOT invent new reference ids or footnotes that are not in kb_items.
If kb_items is empty, then:
- footnotes must be an empty array [],
- reference_ids in all clauses must be [].

========================
HOW TO USE kb_items
========================

The "kb_items" input is a list of JSON objects like:

{
  "id": "cleaning_cancellation_cp1",
  "topic": "cancellation",
  "service_type": "cleaning",
  "label": "Typical cancellation windows for home cleaning",
  "summary": "Many small cleaning businesses use a 24–48 hour cancellation window...",
  "url": "https://example.com/...",
  "source_type": "blog"
}

Guidelines:
- Use kb_items to enrich clause bodies and explanations, and to populate reference_ids and footnotes.
- Do NOT let kb_items override the user’s brief: if the brief says 24 hours notice,
  do not change it to 48 hours just because a kb_item mentions 48 hours.
- When you use a kb_item (in body or explanation), cite it:
  - add its id to clause.explanation.kb_ids_used
  - add its id to clause.reference_ids
  - include it in footnotes
- In explanations, you may say things like:
  - "Many small cleaning businesses use a 24–48 hour cancellation window..."
  - "Some guides suggest limiting accidental damage responsibility to a reasonable cap..."
- Only include kb_items you actually used in the footnotes array; when include_references=true and kb_items is non-empty, do not return an empty reference_ids/footnotes set.

If options.include_references is false, you may:
- set reference_ids to [] for all clauses,
- return an empty footnotes array,
even if kb_items is provided.

========================
WRITING STYLE AND SAFETY
========================

- Contract language should be clear, polite, and practical.
- Use neutral, conservative terms if the brief is vague.
- Do NOT promise things not mentioned in the brief
  (e.g. refunds, warranties, special guarantees).
- If the brief sets a damage_cap_amount, include a clear cap in the damage clause.
- If has_pets=true, include a Pets/Safety clause; otherwise you may omit it
  or keep it very short and generic.

Explanations:
- Are for the user’s understanding, not part of the legal text.
- Should explain in simple language:
  - what this clause is doing,
  - what kind of misunderstandings or conflicts it helps avoid.
- Do NOT mention specific laws, statutes, or court cases.
- You may mention “industry practice” or “small business experience”
  in a general, non-legal way.

========================
OUTPUT FORMAT (MANDATORY)
========================

Return ONLY one JSON object with this shape:

{
  "contract_title": string,
  "preamble": string,
  "governing_note": string,
  "clauses": [
    {
      "clause_id": string,
      "title": string,
      "body": string,
      "explanation": {
        "summary": string,
        "business_risk_note": string,
        "kb_ids_used": [string]
      },
      "reference_ids": [string]
    }
  ],
  "footnotes": [
    {
      "id": string,
      "label": string,
      "summary": string,
      "url": string
    }
  ],
  "generation_meta": {
    "model": string,
    "version": string,
    "generated_at": string
  }
}

Return JSON ONLY, no extra commentary, no markdown.
user Prompt
You will receive three JSON objects:
- "brief": the structured configuration of this service agreement.
- "options": flags controlling explanations and references.
- "kb_items": zero or more knowledge items summarizing common business practices.

Use:
- brief as the single source of truth for what the contract should say.
- kb_items only to enrich explanations and reference footnotes,
  following the system instructions.

Input:

brief:
{{brief_json}}

options:
{{options_json}}

kb_items:
{{kb_items_json}}

Now:
1) Decide which clauses you will include.
2) Use the brief to write clear, neutral contract text for each clause (body).
3) If options.include_explanations is true, write explanations and business_risk_notes.
4) If options.include_references is true and kb_items is not empty,
   connect relevant kb_items to specific clauses using reference_ids and footnotes.

Return ONLY the contract JSON object in the exact format described in the system message.
Do not add any extra text.

1.2.3 KB 设计：kb_items 的格式
定位：
- 提供「行业常见做法」和「业务风险说明」，
- 用于支持合同条款的解释（explanation）和脚注引用（footnotes），
- 让用户知道：为什么条款要这么写，同行一般怎么做。
使用方式：
1. 前端或 Intake API 生成一份 brief（服务类型、频率、价格、取消规则等）。
2. 后端根据 brief.service_type + 若干 topic，
3. 从本地 JSON KB 中筛选出少量条目
4. 调用 ContractGenerate API，输入：
  - brief
  - options
  - kb_items（从 KB 里挑出来的部分）
5. LLM 根据：
  - brief → 写合同正文（左侧）；
  - kb_items → 写条款解释，并在需要处加引用脚注（右侧 + 底部）。
重要：
合同正文只看 brief；
kb_items 只用来写「解释」和「参考来源」。


- 存储形式：本地 JSON 文件
- 建议路径：/data/service_kb.json
- 随项目代码一起 version 控制（Git 管理），方便回滚和审查。
service_kb.json 顶层是一个数组，每一条是一个 KB 条目（KbItem）：
[
  {
    "id": "cleaning_cancellation_cp1",
    "service_type": "cleaning",
    "topic": "cancellation",
    "label": "Typical cancellation windows for home cleaning",
    "summary": "Many small house cleaning businesses use a 24–48 hour cancellation window and may charge the full visit fee for last-minute cancellations to avoid empty time slots.",
    "url": "https://example.com/cleaning-cancellation-guide",
    "source_type": "blog",
    "enabled": true,
    "last_reviewed_at": "2025-12-05"
  },
  {
    "id": "home_services_damage_cap_cp1",
    "service_type": "home_services",
    "topic": "damage",
    "label": "Limiting accidental damage liability",
    "summary": "Home-service providers often set a reasonable cap on accidental damage per visit and exclude antiques or high-value items unless there is a special written agreement.",
    "url": "https://example.com/home-service-damage-cap",
    "source_type": "guide",
    "enabled": true,
    "last_reviewed_at": "2025-12-05"
  }
]

暂时无法在飞书文档外展示此内容
后端筛选 kb 策略：
- 根据 brief ，按照 TF-IDF 进行筛选
- 按分数从高到低，取 4 条kb

1.2.4 条款解释
Service Agreement 生成器中，每一份合同条款，对应3 块内容：
1. 左侧：条款正文
2. 右侧：条款解释（用更直白的语言跟用户解释条款，不是合同一部分）
3. 脚注/来源
条款解释不做的事情：
- 不给出任何法律结论
- 不引用法规条文、法院判决
- 不说“你必须这样写才合法”，只能说“很多小商户这样做是为了避免 XX 风险”。

数据结构：
{
  "clause_id": "cancellation",
  "title": "Cancellations and Rescheduling",
  "body": "If the Client cancels ...",

  "explanation": {
    "summary": "这一条说明客户临时取消时会发生什么，少于 24 小时你可以收取一次完整费用。",
    "business_risk_note": "清洁行业里，临时取消会让你的时间空出来却没有收入，所以很多小商户会设定 24–48 小时的取消窗口，并对临时取消收取全额或部分费用。",
    "kb_ids_used": ["cleaning_cancellation_cp1"]
  },

  "reference_ids": ["cleaning_cancellation_cp1"]
}
字段说明：
暂时无法在飞书文档外展示此内容
1.2.5 优化合同条款阶段
本质上是让用户进行条款精修，达到可用级别
交互：一个主对话框+快捷 「我要修改 xxx」选择框
选择框的 chip，来自于generator API 的 Claude_id
System prompt
You are a contract clause rewriting assistant for a US home & pet care Service Agreement generator.

## Product context

- The product generates draft service agreements for small US service providers
  (cleaning, lawn care, organizing, pool maintenance, window/gutter cleaning,
  pet sitting, etc.).
- You work at **Step 2**: the base contract has already been generated from a structured brief.
- The user now wants to refine ONE specific clause with extra requirements
  (for example: stricter cancellation rules, clearer fragile-items limits, pet safety rules, access/keys details).

You NEVER give legal advice and NEVER judge whether a clause is legally valid or enforceable.
You only help rephrase and integrate the user's business preferences into the wording of this clause.

## Inputs you receive (in the user message)

You will receive a JSON object with the following fields:

- contract_metadata: high-level info about the contract, such as:
  - service_type: e.g. "cleaning", "lawn_care", "organizing", "pool", ...
  - jurisdiction (may be null)
  - other context fields if available
- clause:
  - clause_id: internal id of the clause to refine
  - title: current clause title
  - body: current clause text in English
  - explanation: optional object with:
    - summary: plain-language explanation for the clause owner
    - business_risk_note: how this clause affects the provider's risk
    - kb_ids_used: array of knowledge-base ids used for this explanation
  - reference_ids: optional array of IDs linking to KB items used as citations
- user_note: free-text user request describing how they want this clause to change
  (may be in English or Chinese; treat it as instructions about business preferences, not legal analysis).
- kb_items: OPTIONAL array of knowledge snippets you may use ONLY for explanation and references.
  Each item has:
  - id: knowledge id (string)
  - type: "industry_guide" | "best_practice" | "checklist" | ...
  - title: short title
  - summary: short text description
  - jurisdiction_hint: optional string like "US general", "US cleaning industry"
  DO NOT copy these snippets verbatim; only use them for high-level guidance.

## Your tasks

1. Understand the user_note and decide how it should modify this clause ONLY.
   - Treat user_note as business preferences from a small service provider.
   - Respect the service_type in contract_metadata when possible.
   - If user_note clearly conflicts with the basic logic of the clause,
     try to harmonize it reasonably (e.g. add clarifying conditions)
     instead of blindly following unsafe wording.

2. Rewrite the clause "body" text in clear, neutral US English:
   - Keep the same overall purpose and structure as the original clause.
   - Integrate the user_note in a coherent, professional way.
   - Maintain the same tone as the base contract: simple, practical, and business-friendly.
   - Do NOT include any legal citations, statute names, case law, or "this is legal/illegal" statements.
   - Do NOT reference specific US states or courts unless they are already present in the original clause.

3. Optionally update the explanation section:
   - explanation.summary: short plain-language explanation of what this clause now does.
   - explanation.business_risk_note: how this clause choice affects the provider's risk or expectations,
     in general terms (e.g. "clear cancellation window reduces disputes about last-minute changes").
   - explanation.kb_ids_used:
     - If kb_items were provided and you clearly used one for guidance,
       include its id in this array.
     - If you didn't need any KB, return an empty array.

4. Optionally update reference_ids:
   - If kb_items were provided and relevant, you may map them into reference_ids
     (for example, use the same ids).
   - Otherwise, you may return the original reference_ids or an empty array.
   - Do NOT invent ids.

5. IMPORTANT boundaries:
   - You MUST NOT:
     - say that a clause "complies with" or "violates" any law.
     - claim that the clause is "enforceable", "valid", "legal" or "illegal".
     - give tailored legal advice for any specific jurisdiction.
   - You MAY:
     - explain business effects in generic language:
       "This makes your cancellation policy stricter/clearer",
       "This caps your financial exposure per visit", etc.

6. Safety when user_note is outside scope:
   - If user_note clearly asks for something outside a normal service agreement
     (e.g. criminal matters, immigration, complex corporate transactions),
     you MUST NOT implement those requests.
   - In that case, keep the original clause body unchanged and only adjust the explanation
     to say that the requested change could not be integrated because it is out of scope
     for a simple service agreement tool.
   - You still must return a valid JSON object.

## Output format

You MUST output ONLY a single JSON object with this shape:

{
  "clause_id": string,
  "title": string,
  "body": string,
  "explanation": {
    "summary": string,
    "business_risk_note": string,
    "kb_ids_used": string[]
  },
  "reference_ids": string[]
}

- clause_id MUST be the same as the input clause.clause_id.
- title may be kept or slightly adjusted, but should stay close to the original.
- body MUST be a single clause text suitable for inclusion in a US service agreement.
- No extra keys, no comments, no markdown, no natural-language paragraphs outside the JSON.
User prompt
You are given the current contract metadata, the original clause, the user's requested changes for this clause, and optional KB items.

Please refine ONLY this clause according to the instructions and return a JSON object in the required format.

<INPUT_JSON>
{{payload_json}}
</INPUT_JSON_JSON>


2.其他需求
2.1 付费与订阅
- 支持单份合同下载的付费
- 支持按月订阅和按年订阅
单份付费：5 美金
按月订阅：15 美金
按年订阅：166 美金
权益：
权益
Free
Single (\$5)
Monthly (\$15)
Yearly (\$166)
生成并预览合同
✅
✅
✅
✅
条款优化次数
3 次
5 次
100 次/月
无限
下载 PDF/Word
❌
1 份
无限
无限
2.2登录
无需登录即可进行第一阶段的生成，填表后再次生成需要登录
- 登录与数据保留：在登录流程中传递 ?resume_brief={{brief_id}}，OAuth 回调后自动恢复表单。若使用邮箱登录，发送 magic link 邮件时在 URL 中携带 brief 快照。


2.3 历史记录
保存近 30 天的合同记录
三、相关 API
API key：请在部署环境配置为 `LLM_API_KEY`，不要写入仓库文件
调用地址：`LLM_API_BASE`（示例：https://api.openai.com）
ContractIntake API：使用 gpt-5-mini
Generate API：使用 gpt-5.1-2025-11-13
优化合同条款：使用 gpt-5.1-2025-11-13

相关文档
# Chat(聊天)

## OpenAPI Specification

```yaml
openapi: 3.0.1
info:
  title: ''
  description: ''
  version: 1.0.0
paths:
  /v1/chat/completions:
    post:
      summary: Chat(聊天)
      deprecated: false
      description: >+
        [官方指南](https://platform.openai.com/docs/guides/text-generation/chat-completions-api)

        [官方API文档](https://platform.openai.com/docs/api-reference/chat)

        所有对话模型，都可使用此接口， 修改 model 属性为模型名

        给定一个提示，该模型将返回一个或多个预测的完成，并且还可以返回每个位置的替代标记的概率。

        为提供的提示和参数创建完成


      tags:
        - 聊天(Chat)
      parameters:
        - name: Content-Type
          in: header
          description: ''
          required: true
          example: application/json
          schema:
            type: string
        - name: Accept
          in: header
          description: ''
          required: true
          example: application/json
          schema:
            type: string
        - name: Authorization
          in: header
          description: ''
          required: false
          example: Bearer {{YOUR_API_KEY}}
          schema:
            type: string
            default: Bearer {{YOUR_API_KEY}}
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                model:
                  type: string
                  description: |+
                    要使用的模型的 ID。有关哪些模型可与聊天 API 一起使用的详细信息,请参阅模型端点兼容性表。

                messages:
                  type: array
                  items:
                    type: object
                    properties:
                      role:
                        type: string
                      content:
                        type: string
                    x-apifox-orders:
                      - role
                      - content
                  description: 至今为止对话所包含的消息列表。Python 代码示例。
                temperature:
                  type: integer
                  description: >-
                    使用什么采样温度，介于 0 和 2 之间。较高的值（如 0.8）将使输出更加随机，而较低的值（如
                    0.2）将使输出更加集中和确定。  我们通常建议改变这个或`top_p`但不是两者。
                top_p:
                  type: integer
                  description: >-
                    一种替代温度采样的方法，称为核采样，其中模型考虑具有 top_p 概率质量的标记的结果。所以 0.1 意味着只考虑构成前
                    10% 概率质量的标记。  我们通常建议改变这个或`temperature`但不是两者。
                'n':
                  type: integer
                  description: |-
                    默认为 1
                    为每个输入消息生成多少个聊天补全选择。
                stream:
                  type: boolean
                  description: >-
                    默认为 false 如果设置,则像在 ChatGPT
                    中一样会发送部分消息增量。标记将以仅数据的服务器发送事件的形式发送,这些事件在可用时,并在 data: [DONE]
                    消息终止流。Python 代码示例。
                stop:
                  type: string
                  description: 默认为 null 最多 4 个序列,API 将停止进一步生成标记。
                max_tokens:
                  type: integer
                  description: |-
                    默认为 inf
                    在聊天补全中生成的最大标记数。

                    输入标记和生成标记的总长度受模型的上下文长度限制。计算标记的 Python 代码示例。
                presence_penalty:
                  type: number
                  description: >-
                    -2.0 和 2.0 之间的数字。正值会根据到目前为止是否出现在文本中来惩罚新标记，从而增加模型谈论新主题的可能性。 
                    [查看有关频率和存在惩罚的更多信息。](https://platform.openai.com/docs/api-reference/parameter-details)
                frequency_penalty:
                  type: number
                  description: >-
                    默认为 0 -2.0 到 2.0 之间的数字。正值根据文本目前的存在频率惩罚新标记,降低模型重复相同行的可能性。 
                    有关频率和存在惩罚的更多信息。
                logit_bias:
                  type: 'null'
                  description: >-
                    修改指定标记出现在补全中的可能性。


                    接受一个 JSON 对象,该对象将标记(由标记器指定的标记 ID)映射到相关的偏差值(-100 到
                    100)。从数学上讲,偏差在对模型进行采样之前添加到模型生成的 logit 中。确切效果因模型而异,但-1 和 1
                    之间的值应减少或增加相关标记的选择可能性;如-100 或 100 这样的值应导致相关标记的禁用或独占选择。
                user:
                  type: string
                  description: >-
                    代表您的最终用户的唯一标识符，可以帮助 OpenAI
                    监控和检测滥用行为。[了解更多](https://platform.openai.com/docs/guides/safety-best-practices/end-user-ids)。
                response_format:
                  type: object
                  properties: {}
                  x-apifox-orders: []
                  description: >-
                    指定模型必须输出的格式的对象。  将 { "type": "json_object" } 启用 JSON
                    模式,这可以确保模型生成的消息是有效的 JSON。  重要提示:使用 JSON
                    模式时,还必须通过系统或用户消息指示模型生成
                    JSON。如果不这样做,模型可能会生成无休止的空白流,直到生成达到令牌限制,从而导致延迟增加和请求“卡住”的外观。另请注意,如果
                    finish_reason="length",则消息内容可能会被部分切断,这表示生成超过了 max_tokens
                    或对话超过了最大上下文长度。  显示属性
                seen:
                  type: integer
                  description: >-
                    此功能处于测试阶段。如果指定,我们的系统将尽最大努力确定性地进行采样,以便使用相同的种子和参数进行重复请求应返回相同的结果。不能保证确定性,您应该参考
                    system_fingerprint 响应参数来监控后端的更改。
                tools:
                  type: array
                  items:
                    type: string
                  description: 模型可以调用的一组工具列表。目前,只支持作为工具的函数。使用此功能来提供模型可以为之生成 JSON 输入的函数列表。
                tool_choice:
                  type: object
                  properties: {}
                  description: >-
                    控制模型调用哪个函数(如果有的话)。none 表示模型不会调用函数,而是生成消息。auto
                    表示模型可以在生成消息和调用函数之间进行选择。通过 {"type": "function", "function":
                    {"name": "my_function"}} 强制模型调用该函数。  如果没有函数存在,默认为
                    none。如果有函数存在,默认为 auto。  显示可能的类型
                  x-apifox-orders: []
              required:
                - model
                - messages
                - tools
                - tool_choice
              x-apifox-orders:
                - model
                - messages
                - temperature
                - top_p
                - 'n'
                - stream
                - stop
                - max_tokens
                - presence_penalty
                - frequency_penalty
                - logit_bias
                - user
                - response_format
                - seen
                - tools
                - tool_choice
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  object:
                    type: string
                  created:
                    type: integer
                  choices:
                    type: array
                    items:
                      type: object
                      properties:
                        index:
                          type: integer
                        message:
                          type: object
                          properties:
                            role:
                              type: string
                            content:
                              type: string
                          required:
                            - role
                            - content
                          x-apifox-orders:
                            - role
                            - content
                        finish_reason:
                          type: string
                      x-apifox-orders:
                        - index
                        - message
                        - finish_reason
                  usage:
                    type: object
                    properties:
                      prompt_tokens:
                        type: integer
                      completion_tokens:
                        type: integer
                      total_tokens:
                        type: integer
                    required:
                      - prompt_tokens
                      - completion_tokens
                      - total_tokens
                    x-apifox-orders:
                      - prompt_tokens
                      - completion_tokens
                      - total_tokens
                required:
                  - id
                  - object
                  - created
                  - choices
                  - usage
                x-apifox-orders:
                  - id
                  - object
                  - created
                  - choices
                  - usage
              example:
                id: chatcmpl-123
                object: chat.completion
                created: 1677652288
                choices:
                  - index: 0
                    message:
                      role: assistant
                      content: |-


                        Hello there, how may I assist you today?
                    finish_reason: stop
                usage:
                  prompt_tokens: 9
                  completion_tokens: 12
                  total_tokens: 21
          headers: {}
          x-apifox-name: OK
      security: []
      x-apifox-folder: 聊天(Chat)
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/3868318/apis/api-139393491-run
components:
  schemas: {}
  securitySchemes: {}
servers: []
security: []

```
四、界面及其交互
4.0 相关路由
首页：/
价格页：/pricing
生成页：/contract
模板：/template
4.1 落地页
4.1.1 hero 区域
描述：hero 区域 直接是一个输入框，拥有主标题和副标题，输入后直接跳转到/contract
标题：5-minute contracts for home service pros
副标题：Draft clear service agreements for cleaning, lawn care, pet sitting, and more.
输入框样式：
[图片]
4.1.2 优势说明

Title: Why service pros use this instead of random templates

Block 1
Heading: Built around how you actually work
Body: Choose your type of service – cleaning, lawn & yard care, organizing, pool care, window & gutter cleaning, pet sitting, and more. Your contract is generated to match real jobs, not a generic legal form.

Block 2
Heading: Plain-English clauses with clear explanations
Body: On the left you see the contract text you send to clients. On the right you see simple explanations in everyday language, so you actually understand what each clause does before you use it.

Block 3
Heading: More reliable than generic AI chat
Body: Instead of hallucinating legal-sounding language, each clause is based on a structured brief and industry best-practice snippets. You can see which sources were used, so you know it’s not just made up.

Block 4
Heading: Designed for local home & pet care pros
Body: The clauses focus on the problems you deal with every week: last-minute cancellations, fragile items, pets and safety, access and keys, and no-shows – not corporate law or complex business deals.

4.1.3  功能说明
Title: How it works in 3 simple steps

Step 1
Label: Step 1
Heading: Describe your service in your own words
Body: Start with a simple sentence: “bi-weekly house cleaning for 2-bedroom apartments”, “weekly lawn mowing and edging”, or “overnight pet sitting for small dogs”. The assistant turns that into a structured brief for your contract.

Step 2
Label: Step 2
Heading: Get a full draft contract in under 5 minutes
Body: You instantly get a complete service agreement for your type of work, including services provided, fees, cancellations, damage and fragile items, pets and safety, and access and keys—plus side-by-side explanations in plain English.

Step 3
Label: Step 3
Heading: Fine-tune specific clauses with a helper
Body: Want stricter same-day cancellation rules? Need a clear limit for fragile items? Click “I need to modify…” on any clause, describe what you want, and the assistant rewrites just that section while keeping the rest of your contract intact.

4.1.4  示例说明
Title: See what your contract can look like
Intro: Here are examples of the kind of contracts you can generate in a few minutes.

Example 1
Heading: Example: recurring home cleaning contract
Body: A bi-weekly cleaning agreement for a two-bedroom home with a clear scope of work, what’s included and what’s not, a 24-hour cancellation window, a damage cap per visit, and a short pets and safety clause if there are animals in the home.
Bullets:
- Services: recurring home cleaning, not organizing or moving heavy furniture.
- Cancellations: full fee for same-day cancellations, no fee with 48+ hours’ notice.
- Damage: reasonable cap per visit, clear rules for fragile or high-value items.
- Pets: safe working conditions and the right to pause if behavior is unsafe.
Example 2
Heading: Example: lawn & yard care agreement
Body: A front-yard mowing and edging service with seasonal visits, transparent pricing per visit or per month, simple weather and access rules, and expectations around gates, pets in the yard, and debris on the lawn.
Bullets:
- Services: mowing, edging, and basic cleanup after each visit.
- Schedule: regular visits with flexibility for weather delays.
- Access: clear rules for gates, locks, and obstacles in the yard.
- Safety: guidance for pets, toys, and items left on the grass.
Note: Screenshots and examples are illustrative. Your actual contract will be generated from your own description and preferences.

4.1.5  功能对比
Title: How this compares to templates and generic AI
Intro: You already have options. Here’s how they stack up:

Row 1
Feature: Fits home & pet care work
Templates: Usually generic and not written for cleaning, lawn care, or pet services.
Generic AI: Depends on your prompt; often drifts into vague or irrelevant legal language.
This tool: Built specifically for small home & pet care service providers.

Row 2
Feature: Easy to understand
Templates: Dense legal text only. You have to guess what each clause means.
Generic AI: May be readable, but explanations are buried in the chat, not next to each clause.
This tool: Side-by-side contract text and plain-English explanations for every key clause.

Row 3
Feature: Source & reliability
Templates: You rarely know who wrote them or when they were updated.
Generic AI: Often hallucinated legal-sounding text with no clear sources.
This tool: Uses structured prompts and industry best-practice snippets with source notes.

Row 4
Feature: Time to first usable draft
Templates: Fast to download, slow to adapt to your business.
Generic AI: Takes multiple tries to get something consistent and complete.
This tool: Usually under 5 minutes from your description to a ready-to-edit draft.

Row 5
Feature: Cost
Templates: Free, but you pay with your own time and risk.
Generic AI: Often included in an AI subscription; quality is hit-or-miss.
This tool: Free to generate and review your draft. Pay only when you download the full document.
4.1.6  FAQ
Title: FAQ

Q1
Question: Is this legal advice?
Answer: No. This tool generates draft service agreements and plain-language explanations for general informational purposes only. It is not legal advice and does not replace talking to a licensed attorney in your state.

Q2
Question: Who is this for?
Answer: This assistant is designed for small local service providers in the US who work in and around people’s homes, including home cleaning and housekeeping, lawn and yard care, home organizing and decluttering, pool care and maintenance, window and gutter cleaning, and pet sitting or dog walking. It is not intended for employment contracts, real estate deals, divorce, or complex business transactions.

Q3
Question: How much does it cost?
Answer: You can create and review a customized draft contract for free. If you’re happy with the draft and want to download the full document (for example as a PDF or Word file), you’ll see the price clearly before you pay.

Q4
Question: What about different state laws?
Answer: This tool focuses on clear, practical business terms for typical home and pet care services. It does not check specific state laws or guarantee that any clause is enforceable in a particular jurisdiction. If you have questions about legal requirements in your state, please talk to a local attorney.

Q5
Question: Is my information kept private?
Answer: We only use your answers to generate and improve your contract draft. We do not sell your service details to third parties. For more detail, please see our Privacy Policy.

4.1.7  CTA
Title: Ready to stop guessing your contract terms?
Body: Describe your service once, get a contract you can actually understand, and fine-tune the details with a helper instead of wrestling with random templates.
Primary CTA: Start my contract draft
Secondary note: Free to create and review. Pay only if you decide to download the full document.

4.2 合同生成页
4.2.1  第一阶段
用户在首页输入文案后，点击生成后的页面：
- 加载过程中有 loading 状态
- 加载完成后，给到表单给用户填写
[图片]
相关选项：
API 的字段可能跟这些对不上，以这一份为标准；
Q1. What kind of service do you provide?（服务类型）

Home cleaning
Move-in / move-out cleaning
Short-term rental / Airbnb turnover cleaning
Lawn & yard care (mowing, edging, basic yard work)
Pool care / pool maintenance
Window & gutter cleaning
Home organizing / decluttering
Pet sitting / dog walking
Mixed home services (a bit of everything above)
Other home service (please describe)



Q2. Your business name（商家名称）

自由填写文本，无选项。



Q3. Who do you usually work for?（主要服务对象）

Homeowners and tenants (residential customers)
Small local businesses / offices
Property managers / landlords / HOAs
Short-term rental hosts (Airbnb / VRBO, etc.)
A mix of residential and small business clients
Other types of clients (please describe)



Q4. How often do you provide this service for a typical client?（服务频率）

One-time / occasional jobs only
Weekly (every week)
Every two weeks (bi-weekly)
Monthly
Seasonal (e.g. spring / fall cleanups, pool opening / closing)
It depends / project-based schedule
Other schedule (please describe)



Q5. How do you charge for this service?（收费方式）

Per visit (flat fee per job)
Per hour
Monthly package covering recurring visits
Per project / per quote (price agreed case by case)
Per unit or area (e.g. per room, per yard, per pool, per square foot)
Mixed – depends on the job
Other pricing method (please describe)



Q6. Which cancellation rule fits you best?（取消规则）

Clients must give at least 24 hours’ notice. Same-day cancellations or no-shows may be charged up to the full visit fee.
Clients must give at least 48 hours’ notice. Cancellations within 48 hours may be charged 50–100% of the visit fee.
No cancellation fee, but visits may be rescheduled at your convenience.
I decide case by case and do not want a fixed cancellation fee in the contract.
Other cancellation rule (please describe)

4.2.2  第二阶段
- 入口：用户在 Hero 区填写简要描述 → 完成「Review your service brief」表单 → 点击 Generate contract。
- 目标：
  - 展示一份可直接使用的基础 Service Agreement。
  - 提供条款对应的通俗解释，帮助用户理解。
  - 允许用户按「条款粒度」做二次优化。
  - 提供合同下载功能，并在下载前检查是否已付费（会员或单份购买）。
进入页面时
- 用户从上一页（表单）点击 Generate contract 后：
  - 立即跳转到本页面；
  - 左右栏显示 skeleton 占位（几条灰条代替条款与解释）；
  - Step 2 区域可以先渲染出框架，但说明文字加入一行淡灰小字：
  > Your contract is loading. You can refine clauses after it’s ready.
  （按钮禁用）
- 当合同内容加载成功后：
  - skeleton 消失；
  - Base Contract & Explanations 替换为实际内容；
  - Step 2 区域解除禁用。
Step 导航结构
- 顶部水平导航，包含两个步骤：
1. Step 1 · Review base contract
2. Step 2 · Optimize specific terms (optional)
- 视觉：
  - 当前步骤高亮（底部下划线或背景高亮），另一项为中性状态。
  - 整体风格简洁、科技感，颜色偏中性蓝灰。

路由与锚点行为
- Step 1：
  - 点击行为：
    - 路由更新为：/contract?step=1（示例，具体路径由前端决定）。
    - 页面滚动到页面顶部（Base Contract 开头位置）。
- Step 2：
  - 点击行为：
    - 路由更新为：/contract?step=2。
    - 页面滚动到页面底部 Step 2 区域（有一个 id="step-2" 的 anchor）。
- 初始化：
  - 如果 URL 中含有 step=2，初始渲染完成后滚动到 Step 2 区域。
  - 如果未带参数或为 step=1，停留在页面顶部。

页面总体布局
- 主体分为 左右双栏 + 底部 Step 2 区域：
1. 左栏：Base Contract（基础合同）
2. 右栏：Plain-language explanations（通俗解释）
3. 底部：Step 2 · Optimize specific terms（条款优化入口）
- 在桌面端为左右布局；在窄屏/移动端时可改为上下布局，但交互逻辑不变。

文案结构
- 区块标题：Base Contract
- 说明文案：
> This is your base service agreement. You can use it as-is or add extra requirements below. Each clause matches the plain-language explanation on the right.
- 内容组成：
  1. Contract Title
    - 一行标题文字（如：Service Agreement / Home Cleaning Service Agreement）。
  2. Clauses（条款列表）
    - 每条为一个卡片：
      - 标题：Clause 1, Clause 2…（可附加名称 – Services, – Payment 等）。
      - 正文：多行合同文本。
      - 可能包含引用编号 [1] [2]。
  3. Citation Data
    - 标题：Citation Data
    - 说明文案：
    > Industry sources used for this draft
    - 列表项：1. Data Source Description 等，对应正文中的引用编号。
  4. 下载按钮
    - Download PDF
    - Download Word

下载按钮前端逻辑（含会员/购买检查）

1. 用户点击任意下载按钮时：
  - 按钮进入 loading 状态（文本变为 Checking access… + 小 spinner）。
  - 禁用按钮（防止重复点击）。
2. 前端调用「权限检查」接口（伪逻辑）：
  - 若返回 有下载权限：
    - 继续调用下载接口；
    - 成功后：
      - 触发浏览器下载；
      - 按钮从 loading 恢复正常文本。
    - 失败（网络/服务器错误）：
      - 按钮恢复正常；
      - 在页面右上角弹出错误提示（toast），文案如：
      > We couldn’t generate your file. Please try again.
  - 若返回 无下载权限（非会员且未购买此合同）：
    - 按钮恢复正常；
    - 前端重定向到购买页面（单份购买页）：
      - 例如：/pricing/contract-download?from=contract-page&format=pdf
      - 是否会员、会员权益说明等不在本页面展示，由购买页负责。

文案结构
- 标题：Plain-language explanations
- 说明文案：
> Each card explains what the matching clause on the left is doing in simple language. These explanations are for your understanding only and are not part of the legal contract.
- 每个解释卡片：
  - 标题：Clause 1, Clause 2…（与左侧条款编号对应）。
  - 正文：1–3 段通俗文字。

左右联动物理逻辑

- 当用户 hover / 点击左侧某条款卡片：
  - 左侧该卡片高亮；
  - 右侧对应解释卡片同步高亮。
- 当用户 hover / 点击右侧某解释卡片：
  - 右侧该卡片高亮；
  - 左侧对应条款卡片同步高亮。
- 高亮样式：
  - 边框颜色加深 + 背景略微变深（仍保持中性严肃配色）。

区块结构
- id="step-2"，用于顶部导航锚点。
- 标题：Step 2 · Tell the assistant what to refine
- 说明文案：
> Use an option below, then describe your extra requirement in plain language. We’ll update only the matching clause in your contract.
- 子组件：
  1. Modify: 下拉框（选择要修改的条款）
  2. 文本输入框（描述修改需求）
  3. 发送按钮（纸飞机 icon）

Modify 下拉框

- 默认占位项（禁用选择）：
  - Select a clause to modify…
- 选项列表（由前端根据合同条款生成）示例：
  - Clause 1 – Services provided
  - Clause 2 – Payment & invoicing
  - Clause 3 – Cancellations
  - Clause 4 – Damage & liability
  - Other clause (describe in your message)
- 当选中某条款时：
  - 左侧对应条款卡片 & 右侧解释卡片高亮；
  - 文本输入框 placeholder 更新为与该条款相关的提示：
    - 例如：
    Explain how you’d like your cancellation policy to change…

输入框与发送按钮

- 输入框 placeholder（未选条款时）：
  - Enter your revision suggestions…
- 按钮状态规则：
  - 当 未选择条款 或 输入内容为空 时：
    - 按钮禁用（灰态，无点击效果）。
  - 当已选择条款且输入不为空时：
    - 按钮可点击。
[图片]
4.2.2  第三阶段
点击发送后的行为（loading 状态）

1. 用户点击发送按钮：
  - Step 2 区域状态：
    - 下拉框与文本输入框 disabled（不可编辑）。
    - 发送按钮进入 loading 状态：
      - 文案变为 Updating clause…
      - 显示小 spinner。
  - 左侧对应条款卡片：
    - 在卡片右上角显示一个 “Updating…” 状态徽标；
    - 卡片可加轻微灰色蒙层，表示正在更新。
  - 右侧对应解释卡片：
    - 同样显示 “Updating…” 徽标或灰色蒙层

请求成功（success 状态）

- 后端返回更新后的条款 & 解释内容后，前端：
1. 更新左侧对应条款正文文本；
2. 更新右侧对应解释卡片正文文本；
3. 状态恢复：
  - Step 2 中的下拉框 & 输入框恢复可编辑；
  - 输入框清空；
  - 发送按钮恢复为默认文案（纸飞机 icon + Send 或不显示文字）。
4. 条款更新标记：
  - 左侧条款标题旁显示一个绿色小徽标：Updated；
  - 右侧解释卡片标题旁也显示同样徽标。
5. Toast 提示：
  - 在页面右上角弹出成功提示：
  > Clause updated successfully.
  - 2–3 秒后自动消失。

请求失败（error 状态）

- 若请求返回错误或超时：
1. 不修改条款内容；
2. Step 2 中的控件恢复可编辑（保留用户刚刚输入的内容，方便用户重试或稍作修改）；
3. 左右卡片上的 “Updating…” 状态与蒙层移除；
4. Toast 错误提示：
  - 文案示例：
  > We couldn’t update this clause. Please try again.
  - 2–3 秒后自动消失。
五、日志构建
需要构建以下日志：
- Contract intake API 的输入和输出（包括 prompt）
- Generator API 的输入和输出（包括 prompt）
- 优化合同条款的输入和输出（包括 prompt）
- kb 的引用数据

日志只给开发者查看，用于排查 bug
